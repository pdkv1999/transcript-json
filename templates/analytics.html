<!-- templates/analytics.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{{ header.get('report_title', 'Analytics Report') }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --ink: #111827; --muted: #4b5563; --line: #e5e7eb;
      --hi: #dc2626; --some: #f59e0b; --no: #10b981;
      --bg: #ffffff; --card: #ffffff;
      --ok: #ecfdf5; --err: #fee2e2;
    }
    html, body { margin: 0; padding: 0; background: var(--bg); color: var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
      line-height: 1.4; }
    .container { max-width: 980px; margin: 20px auto 64px; padding: 20px; background: var(--card);
      box-shadow: 0 1px 2px rgba(0,0,0,0.04); border-radius: 10px; }
    header h1 { margin: 0 0 4px; font-size: 22px; }
    header p { margin: 0; color: var(--muted); }
    .meta { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px 14px; margin-top: 10px;
      padding-top: 10px; border-top: 1px solid var(--line); font-size: 14px; }
    .meta div span { color: var(--muted); }
    .toolbar { display: flex; gap: 8px; justify-content: flex-end; margin: 12px 0 18px;
      position: sticky; top: 0; background: var(--bg); padding: 8px 0; z-index: 10; }
    .mode-controls { margin-right: auto; display:flex; gap:8px; align-items:center; }
    button { border: 1px solid var(--line); background: #fff; border-radius: 8px; padding: 8px 12px; font-size: 14px; cursor: pointer; }
    button.primary { background: #111827; color: #fff; border-color: #111827; }
    button.mode { background:#fff; border-radius:6px; padding:6px 10px; font-size:13px; }
    button.mode.active { background:#111827; color:#fff; border-color:#111827; }
    .section { margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--line); }
    .section h2 { font-size: 16px; margin: 0 0 8px; }
    .summary { white-space: pre-wrap; background: #f9fafb; border: 1px solid var(--line); border-radius: 8px; padding: 12px; font-size: 15px; min-height: 56px; }
    .quote { color: var(--muted); font-style: italic; margin-top: 8px; }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .chip { border-radius: 999px; padding: 6px 10px; font-size: 13px; color: #fff; }
    .chip.hi { background: var(--hi); } .chip.some { background: var(--some); } .chip.no { background: var(--no); }
    .domains { display: grid; gap: 12px; margin-top: 12px; grid-template-columns: repeat(3, 1fr); }
    .domain-card { border: 1px solid var(--line); border-radius: 10px; padding: 12px; background: #fff; min-height:120px; }
    .domain-title { font-weight: 600; margin: 0 0 6px; display:flex; align-items:center; justify-content: space-between; gap: 12px; }
    .domain-badge { display: inline-block; padding: 6px 10px; border-radius: 999px; font-size: 12px; color: #fff; margin-left: 8px; white-space:nowrap; }
    .badge-hi { background: var(--hi); } .badge-some { background: var(--some); } .badge-no { background: var(--no); }
    .foot { display: flex; justify-content: space-between; align-items: center; color: var(--muted); font-size: 12px; margin-top: 16px; }
    .status { padding: 8px 10px; border-radius: 8px; margin-bottom: 12px; display:none; }
    .status.show { display:block; }
    .status.ok { background: var(--ok); }
    .status.err { background: var(--err); }
    canvas { max-width: 100%; }
    @media (max-width:900px) {
      .domains { grid-template-columns: repeat(1, 1fr); }
      .meta { grid-template-columns: repeat(2, 1fr); }
    }
    @media print { .toolbar, .status { display:none !important; } .container { box-shadow:none; border-radius:0; margin:0; } }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="container" id="report-root">
    <header>
      <h1 id="report-title">{{ header.get('report_title', 'Analytics Report') }}</h1>
      <p>Parent Telephone Interview Summary</p>
      <div class="meta" id="meta">
        <div><span>Child Name:</span> <b id="child-name">{{ header.get('child_name', '—') }}</b></div>
        <div><span>Age:</span> <b id="child-age">{{ header.get('child_age', '—') }}</b></div>
        <div><span>Date of Interview:</span> <b id="doi">{{ header.get('date_of_interview', '—') }}</b></div>
        <div><span>Parent Respondent:</span> <b id="parent">{{ header.get('parent_respondent', '—') }}</b></div>
        <div><span>Interviewer:</span> <b id="interviewer">{{ header.get('interviewer', '—') }}</b></div>
        <div><span>Referral Source:</span> <b id="ref-source">{{ header.get('referral_source', '—') }}</b></div>
      </div>
    </header>

    <div class="toolbar">
      <div class="mode-controls">
        <button id="modeFreq" class="mode active">Use Frequency</button>
        <button id="modeQuotes" class="mode">Use Quotes</button>
      </div>
      <button id="uploadBtn">Upload CSV</button>
      <button id="regen">Regenerate insights</button>
      <button id="save" class="primary">Save Report</button>
      <button id="print">Print Report</button>
    </div>

    <div id="status" class="status"></div>

    <!-- Hidden file input for upload -->
    <input id="fileInput" type="file" accept=".csv,.tsv,.txt,.json,.xlsx,.xls" style="display:none" />

    <section class="section">
      <h2>Summary of Key Findings</h2>
      <div id="summary" class="summary">Loading…</div>
      <div id="parent-quote" class="quote"></div>
    </section>

    <section class="section">
      <h2>Traffic-Light Summary of Concerns</h2>
      <div><b>High Concerns:</b> <span id="tl-high">—</span></div>
      <div style="margin-top:6px;"><b>Some Concerns:</b> <span id="tl-some">—</span></div>
      <div style="margin-top:6px;"><b>No Concerns:</b> <span id="tl-no">—</span></div>
      <div class="chips" id="chips-hi" style="margin-top:8px;"></div>
      <div class="chips" id="chips-some" style="margin-top:6px;"></div>
      <div class="chips" id="chips-no" style="margin-top:6px;"></div>
    </section>

    <section class="section">
      <h2>Burden of Conversation (Parent-Reported Focus)</h2>
      <canvas id="burdenChart" height="240"></canvas>
      <div style="font-size:12px;color:var(--muted); margin-top:8px;">
        Chart shows each domain's share (sums ≈ 100%). Use "Use Frequency" or "Use Quotes" to switch modes.
      </div>
    </section>

    <section class="section">
      <h2>Recommendations and Next Steps (Based on Parent Concerns)</h2>
      <ul id="recs" style="margin:0; padding-left:20px;"></ul>
    </section>

    <section class="section">
      <h2>Page 2 – Domain-Specific Notes & Quotes</h2>
      <div class="domains" id="domains"></div>
    </section>

    <div class="foot">
      <div>
        This summary is based on a parent telephone interview and is for discussion purposes only.
        It does not replace a full clinical assessment.
      </div>
      <div id="stamp"></div>
    </div>
  </div>

  <script>
    const sessionId = "{{ session_id }}";
    const regenBtn = document.getElementById('regen');
    const saveBtn = document.getElementById('save');
    const printBtn = document.getElementById('print');
    const modeFreqBtn = document.getElementById('modeFreq');
    const modeQuotesBtn = document.getElementById('modeQuotes');
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('fileInput');

    const statusEl = document.getElementById('status');
    const stampEl = document.getElementById('stamp');

    const summaryEl = document.getElementById('summary');
    const quoteEl = document.getElementById('parent-quote');

    const tlHighEl = document.getElementById('tl-high');
    const tlSomeEl = document.getElementById('tl-some');
    const tlNoEl = document.getElementById('tl-no');

    const chipsHi = document.getElementById('chips-hi');
    const chipsSome = document.getElementById('chips-some');
    const chipsNo = document.getElementById('chips-no');

    const recsEl = document.getElementById('recs');
    const domainsEl = document.getElementById('domains');

    let chartInstance = null;
    let rows_cache = null;
    let currentMode = "frequency"; // or "quotes"

    const DOMAIN_ORDER = [
      "Attention / ADHD",
      "Learning / Dyslexia",
      "Sleep",
      "Motor Skills",
      "Anxiety / Emotion",
      "Social / Communication",
      "Eating"
    ];

    function showStatus(msg, type="ok") {
      statusEl.textContent = msg;
      statusEl.className = `status show ${type === "err" ? "err" : "ok"}`;
    }
    function clearStatus() { statusEl.className = "status"; statusEl.textContent = ""; }
    function setStamp() {
      const dt = new Date();
      stampEl.textContent = "Last generated: " +
        dt.toLocaleDateString(undefined, {year:"numeric", month:"short", day:"2-digit"}) + " " +
        dt.toLocaleTimeString(undefined, {hour:"2-digit", minute:"2-digit"});
    }

    function parseList(value) {
      if (!value) return [];
      if (Array.isArray(value)) return value;
      const raw = String(value).split(/\r?\n|,/).map(s => s.trim()).filter(Boolean);
      const seen = new Set(); const out = [];
      for (const s of raw) { if (!seen.has(s.toLowerCase())) { seen.add(s.toLowerCase()); out.push(s); } }
      return out;
    }

    function chip(text, cls) { const d = document.createElement('div'); d.className = `chip ${cls}`; d.textContent = text; return d; }

    function badge(level) {
      const span = document.createElement('span');
      span.className = "domain-badge " + (level === "high" ? "badge-hi" : level === "some" ? "badge-some" : "badge-no");
      span.textContent = level === "high" ? "High concern" : level === "some" ? "Some concern" : "No concern";
      return span;
    }

    function levelFromPercent(p) {
      if (p === null || p === undefined) return "some";
      const x = Number(p) || 0;
      if (x > 70) return "high";
      if (x >= 40) return "some";
      if (x < 30) return "no";
      return "some";
    }

    function buildChartData(domain_scores_obj, mode) {
      const labels = [];
      const values = [];
      DOMAIN_ORDER.forEach(d => {
        let val = 0;
        const entry = domain_scores_obj && domain_scores_obj[d];
        if (!entry) { val = 0; }
        else {
          if (mode === "frequency") {
            val = Number(entry.freq_share || entry.freq_percent || 0);
          } else {
            val = Number(entry.quote_share || 0);
          }
        }
        labels.push(d);
        values.push(Math.max(0, Number(val)));
      });

      const sum = values.reduce((a,b) => a+b, 0);
      if (sum > 0 && !(Math.abs(sum - 100) <= 1)) {
        for (let i=0;i<values.length;i++) values[i] = (values[i] / sum) * 100;
      }
      const rounded = values.map(v => Math.round(v * 10) / 10);
      return { labels, values: rounded };
    }

    function renderBurdenChart(domain_scores_obj, mode) {
      const canvas = document.getElementById('burdenChart');
      canvas.style.height = '320px';
      canvas.height = 320;
      const ctx = canvas.getContext('2d');
      const { labels, values } = buildChartData(domain_scores_obj, mode);

      if (chartInstance) {
        try { chartInstance.destroy(); } catch (e) {}
        chartInstance = null;
      }

      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Share (%)',
            data: values,
            backgroundColor: labels.map((l, i) => {
              const palette = ['#e8505b','#f08a4b','#f5b86b','#b9d36b','#7fd0a8','#6fc2d6','#9ea0ff'];
              return palette[i % palette.length];
            }),
            borderColor: 'rgba(0,0,0,0.03)',
            borderWidth: 1,
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 4,
          scales: {
            x: {
              beginAtZero: true,
              max: 100,
              ticks: { callback: (v) => `${v}%` }
            },
            y: {
              ticks: { autoSkip: false },
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(ctx) { return `${ctx.parsed.x}%`; }
              }
            }
          }
        }
      });
    }

    function renderTrafficLights(rows, mode) {
      chipsHi.innerHTML = ""; chipsSome.innerHTML = ""; chipsNo.innerHTML = "";
      // use server-provided lists: traffic_freq_* or traffic_quote_*
      let hiList = [], someList = [], noList = [];
      if (mode === "frequency") {
        hiList = rows?.traffic_freq_high?.list || parseList(rows?.traffic_freq_high?.value);
        someList = rows?.traffic_freq_some?.list || parseList(rows?.traffic_freq_some?.value);
        noList = rows?.traffic_freq_no?.list || parseList(rows?.traffic_freq_no?.value);
      } else {
        hiList = rows?.traffic_quote_high?.list || parseList(rows?.traffic_quote_high?.value);
        someList = rows?.traffic_quote_some?.list || parseList(rows?.traffic_quote_some?.value);
        noList = rows?.traffic_quote_no?.list || parseList(rows?.traffic_quote_no?.value);
      }

      // ensure no duplication across lists: prefer hi > some > no
      const deduped = new Set();
      const finalHi = [], finalSome = [], finalNo = [];
      for (const x of hiList || []) { if (!deduped.has(x.toLowerCase())) { deduped.add(x.toLowerCase()); finalHi.push(x); } }
      for (const x of someList || []) { if (!deduped.has(x.toLowerCase())) { deduped.add(x.toLowerCase()); finalSome.push(x); } }
      for (const x of noList || []) { if (!deduped.has(x.toLowerCase())) { deduped.add(x.toLowerCase()); finalNo.push(x); } }

      tlHighEl.textContent = finalHi.length ? finalHi.join(", ") : "—";
      tlSomeEl.textContent = finalSome.length ? finalSome.join(", ") : "—";
      tlNoEl.textContent = finalNo.length ? finalNo.join(", ") : "—";

      finalHi.forEach(x => chipsHi.appendChild(chip(x, "hi")));
      finalSome.forEach(x => chipsSome.appendChild(chip(x, "some")));
      finalNo.forEach(x => chipsNo.appendChild(chip(x, "no")));
    }

    function renderRecommendations(rows) {
      recsEl.innerHTML = "";
      const items = parseList(rows?.recommendations?.value || rows?.recommendations || "");
      if (!items.length) {
        const li = document.createElement('li'); li.textContent = "—"; recsEl.appendChild(li); return;
      }
      items.forEach(line => {
        const li = document.createElement('li'); li.textContent = line; recsEl.appendChild(li);
      });
    }

    function renderDomains(rows, mode) {
      domainsEl.innerHTML = "";
      const domain_objects = rows.domain_objects || rows.domain_objects || {};
      for (const title of DOMAIN_ORDER) {
        const obj = domain_objects[title] || (rows['domain_' + title.toLowerCase().replace(/[^a-z0-9]+/g, '_')] || {});
        const card = document.createElement('div'); card.className = "domain-card";
        const h = document.createElement('div'); h.className = "domain-title";
        const left = document.createElement('div'); left.textContent = title;
        const level = (() => {
          if (mode === "frequency") return levelFromPercent(obj.freq_percent || obj.freq_share || 0);
          return levelFromPercent(obj.quote_share || 0);
        })();
        const right = badge(level);
        h.appendChild(left); h.appendChild(right); card.appendChild(h);

        // VALUE LINE: show mapped value (if exists) or NA — no percentages are shown here anymore
        const valLine = document.createElement('div');
        valLine.style.fontWeight = '600';
        valLine.style.marginBottom = '6px';
        const shownText = obj.value || "NA";
        valLine.textContent = shownText || "—";
        card.appendChild(valLine);

        if (obj.quote) {
          const q = document.createElement('div'); q.className = "quote";
          q.textContent = '“' + String(obj.quote).replace(/^["“]+|["”]+$/g,'') + '”';
          card.appendChild(q);
        } else {
          const q = document.createElement('div'); q.className = "quote";
          q.style.opacity = 0.8;
          q.textContent = "—";
          card.appendChild(q);
        }

        // META: only show number of quotes (no percent)
        const meta = document.createElement('div'); meta.style.marginTop = '8px'; meta.style.color = 'var(--muted)'; meta.style.fontSize = '13px';
        meta.textContent = `Quotes: ${obj.quote_count || 0}`;
        card.appendChild(meta);

        domainsEl.appendChild(card);
      }
    }

    async function regenerate() {
      clearStatus();
      showStatus("Generating insights…", "ok");
      summaryEl.textContent = "Loading…";
      quoteEl.textContent = "";
      recsEl.innerHTML = "";
      domainsEl.innerHTML = "";
      chipsHi.innerHTML = chipsSome.innerHTML = chipsNo.innerHTML = "";
      try {
        const res = await fetch(`/api/analytics/${encodeURIComponent(sessionId)}`);
        if (!res.ok) {
          const errBody = await res.text();
          showStatus("Analytics API error: " + res.status + " — see server logs", "err");
          summaryEl.textContent = "Error calling analytics API.";
          console.error("Analytics API failed:", res.status, errBody);
          return;
        }
        const data = await res.json();
        if (!data || !data.ok) {
          showStatus("Analytics responded with error: " + (data && data.error ? data.error : "unknown"), "err");
          summaryEl.textContent = "Error from analytics API.";
          return;
        }

        rows_cache = data.rows || {};
        const h = data.header || {};
        document.getElementById("child-name").textContent = h.child_name || "—";
        document.getElementById("child-age").textContent = h.child_age || "—";
        document.getElementById("doi").textContent = h.date_of_interview || "—";
        document.getElementById("parent").textContent = h.parent_respondent || "—";
        document.getElementById("interviewer").textContent = h.interviewer || "—";
        document.getElementById("ref-source").textContent = h.referral_source || "—";
        if (h.report_title) document.getElementById("report-title").textContent = h.report_title;

        summaryEl.textContent = rows_cache?.summary_overview?.value || rows_cache?.summary_overview || "—";
        const pq = (rows_cache?.parent_quote && (rows_cache.parent_quote.quote || rows_cache.parent_quote.value)) || rows_cache.parent_quote || "";
        quoteEl.textContent = pq ? ('Parent Quote: “' + pq + '”') : "";

        renderRecommendations(rows_cache);
        renderTrafficLights(rows_cache, currentMode);
        renderDomains(rows_cache, currentMode);

        // Chart
        const domain_scores = rows_cache.domain_scores || {};
        renderBurdenChart(domain_scores, currentMode);

        setStamp();
        showStatus("Insights generated successfully.", "ok");
      } catch (e) {
        console.error("Regenerate failed:", e);
        showStatus("Failed to generate insights. See console/server logs.", "err");
        summaryEl.textContent = "Failed to generate insights.";
      }
    }

    async function uploadAndGenerate(file) {
      if (!file) return;
      clearStatus();
      showStatus("Uploading file and generating insights…", "ok");
      summaryEl.textContent = "Loading…";
      quoteEl.textContent = "";
      recsEl.innerHTML = "";
      domainsEl.innerHTML = "";
      chipsHi.innerHTML = chipsSome.innerHTML = chipsNo.innerHTML = "";

      try {
        const form = new FormData();
        form.append('file', file, file.name);

        const res = await fetch('/api/analytics/upload', {
          method: 'POST',
          body: form
        });

        if (!res.ok) {
          const text = await res.text();
          console.error("Upload failed:", res.status, text);
          showStatus("Upload failed: " + res.status + " — see server logs", "err");
          summaryEl.textContent = "Upload failed.";
          return;
        }

        const data = await res.json();
        if (!data || !data.ok) {
          showStatus("Upload analytics error: " + (data && data.error ? data.error : "unknown"), "err");
          summaryEl.textContent = "Error processing uploaded file.";
          return;
        }

        // reuse same rendering pipeline
        rows_cache = data.rows || {};
        const h = data.header || {};
        document.getElementById("child-name").textContent = h.child_name || "—";
        document.getElementById("child-age").textContent = h.child_age || "—";
        document.getElementById("doi").textContent = h.date_of_interview || "—";
        document.getElementById("parent").textContent = h.parent_respondent || "—";
        document.getElementById("interviewer").textContent = h.interviewer || "—";
        document.getElementById("ref-source").textContent = h.referral_source || "—";
        if (h.report_title) document.getElementById("report-title").textContent = h.report_title;

        summaryEl.textContent = rows_cache?.summary_overview?.value || rows_cache?.summary_overview || "—";
        const pq = (rows_cache?.parent_quote && (rows_cache.parent_quote.quote || rows_cache.parent_quote.value)) || rows_cache.parent_quote || "";
        quoteEl.textContent = pq ? ('Parent Quote: “' + pq + '”') : "";

        renderRecommendations(rows_cache);
        renderTrafficLights(rows_cache, currentMode);
        renderDomains(rows_cache, currentMode);

        // Chart
        const domain_scores = rows_cache.domain_scores || {};
        renderBurdenChart(domain_scores, currentMode);

        setStamp();
        showStatus("Insights generated from uploaded file.", "ok");
      } catch (e) {
        console.error("UploadAndGenerate failed:", e);
        showStatus("Failed to upload or generate insights. See console/server logs.", "err");
        summaryEl.textContent = "Failed to upload or generate insights.";
      }
    }

    modeFreqBtn.addEventListener('click', () => {
      currentMode = "frequency";
      modeFreqBtn.classList.add('active'); modeQuotesBtn.classList.remove('active');
      if (rows_cache) {
        renderTrafficLights(rows_cache, currentMode);
        renderDomains(rows_cache, currentMode);
        renderBurdenChart(rows_cache.domain_scores || {}, currentMode);
      }
    });
    modeQuotesBtn.addEventListener('click', () => {
      currentMode = "quotes";
      modeQuotesBtn.classList.add('active'); modeFreqBtn.classList.remove('active');
      if (rows_cache) {
        renderTrafficLights(rows_cache, currentMode);
        renderDomains(rows_cache, currentMode);
        renderBurdenChart(rows_cache.domain_scores || {}, currentMode);
      }
    });

    regenBtn.addEventListener('click', regenerate);
    printBtn.addEventListener('click', () => window.print());
    saveBtn.addEventListener('click', () => window.print());

    // Upload handlers
    uploadBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (ev) => {
      const f = ev.target.files && ev.target.files[0];
      if (!f) return;
      uploadAndGenerate(f);
      // clear input so same file can be re-uploaded if needed
      fileInput.value = "";
    });

    // Auto-load
    regenerate();
  </script>
</body>
</html>

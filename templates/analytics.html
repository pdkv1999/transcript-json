<!-- templates/analytics.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{{ header.get('report_title', 'Analytics Report') }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --ink: #111827; --muted: #4b5563; --line: #e5e7eb;
      --hi: #dc2626; --some: #f59e0b; --no: #10b981;
      --bg: #ffffff; --card: #ffffff;
      --ok: #ecfdf5; --err: #fee2e2;
    }
    html, body {
      margin: 0; padding: 0; background: var(--bg); color: var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
      line-height: 1.4; -webkit-print-color-adjust: exact;
    }
    .container {
      max-width: 980px; margin: 20px auto 64px; padding: 20px; background: var(--card);
      box-shadow: 0 1px 2px rgba(0,0,0,0.04); border-radius: 10px;
    }
    header h1 { margin: 0 0 4px; font-size: 22px; }
    header p { margin: 0; color: var(--muted); }
    .meta {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px 14px; margin-top: 10px;
      padding-top: 10px; border-top: 1px solid var(--line); font-size: 14px;
    }
    .meta div span { color: var(--muted); }

    .toolbar {
      display: flex; gap: 8px; justify-content: flex-end; margin: 12px 0 18px;
      position: sticky; top: 0; background: var(--bg); padding: 8px 0; z-index: 10;
    }
    .mode-controls { margin-right: auto; display:flex; gap:8px; align-items:center; }

    button {
      border: 1px solid var(--line); background: #fff;
      border-radius: 8px; padding: 8px 12px; font-size: 14px; cursor: pointer;
    }
    button.primary { background: #111827; color: #fff; border-color: #111827; }
    button.mode { background:#fff; border-radius:6px; padding:6px 10px; font-size:13px; }
    button.mode.active { background:#111827; color:#fff; border-color:#111827; }

    .section { margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--line); }
    .section h2 { font-size: 16px; margin: 0 0 8px; }

    .summary {
      white-space: pre-wrap; background: #f9fafb; border: 1px solid var(--line);
      border-radius: 8px; padding: 12px; font-size: 15px; min-height: 56px;
    }
    .quote { color: var(--muted); font-style: italic; margin-top: 8px; }

    .chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .chip {
      border-radius: 999px; padding: 6px 10px; font-size: 13px; color: #fff;
    }
    .chip.hi { background: var(--hi); }
    .chip.some { background: var(--some); }
    .chip.no { background: var(--no); }

    /* Domains one column */
    .domains {
      display: grid; gap: 12px; margin-top: 12px; grid-template-columns: 1fr;
    }
    .domain-card {
      border: 1px solid var(--line); border-radius: 10px; padding: 12px;
      background: #fff; min-height:120px;
    }
    .domain-title {
      font-weight: 600; margin: 0 0 6px; display:flex;
      align-items:center; justify-content: space-between; gap: 12px;
    }
    .domain-badge {
      display: inline-block; padding: 6px 10px; border-radius: 999px;
      font-size: 12px; color: #fff; margin-left: 8px; white-space:nowrap;
    }
    .badge-hi { background: var(--hi); }
    .badge-some { background: var(--some); }
    .badge-no { background: var(--no); }

    .foot {
      display: flex; justify-content: space-between; align-items: center;
      color: var(--muted); font-size: 12px; margin-top: 16px;
    }

    .status {
      padding: 8px 10px; border-radius: 8px; margin-bottom: 12px; display:none;
    }
    .status.show { display:block; }
    .status.ok { background: var(--ok); }
    .status.err { background: var(--err); }

    canvas {
      max-width: 100%; display: block; margin: 8px 0; height: 320px;
    }

    .quotes-list { margin-top: 6px; display: grid; gap: 6px; }
    .quote-line {
      color: var(--muted); font-style: italic; font-size: 14px;
    }
    .show-more {
      margin-top: 8px; font-size: 13px; color: #111827;
      background: transparent; border: none; cursor: pointer;
      text-decoration: underline; padding: 0;
    }

    @media print {
      .toolbar, .status { display:none !important; }
      .container { box-shadow:none; border-radius:0; margin:0; }

      /* Each major section on its own page */
      .page-break {
        page-break-before: always;
        break-before: page;
      }

      canvas {
        height: 400px !important;
        max-height: 400px !important;
        page-break-inside: avoid;
        -webkit-print-color-adjust: exact;
        display: block;
      }

      .domains { grid-template-columns: 1fr !important; }
      .domain-card { page-break-inside: avoid; }

      /* ðŸ”¹ In print: show all quotes, hide the "Show more" button */
      .hidden-quotes {
        display: block !important;
      }
      .show-more {
        display: none !important;
      }
    }

    @media (max-width:900px) {
      .meta { grid-template-columns: repeat(2, 1fr); }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="container" id="report-root">
    <header>
      <h1 id="report-title">{{ header.get('report_title', 'Analytics Report') }}</h1>
      <div class="meta" id="meta">
        <div><span>Child Name:</span> <b id="child-name">{{ header.get('child_name', 'â€”') }}</b></div>
        <div><span>Age:</span> <b id="child-age">{{ header.get('child_age', 'â€”') }}</b></div>
        <div><span>Date of Interview:</span> <b id="doi">{{ header.get('date_of_interview', 'â€”') }}</b></div>
        <div><span>Parent Respondent:</span> <b id="parent">{{ header.get('parent_respondent', 'â€”') }}</b></div>
        <div><span>Interviewer:</span> <b id="interviewer">{{ header.get('interviewer', 'â€”') }}</b></div>
        <div><span>Referral Source:</span> <b id="ref-source">{{ header.get('referral_source', 'â€”') }}</b></div>
      </div>
    </header>

    <div class="toolbar">
      <div class="mode-controls">
        <button id="modeFreq" class="mode active">Use Frequency</button>
        <button id="modeQuotes" class="mode">Use Quotes</button>
      </div>
      <button id="uploadBtn">Upload CSV</button>
      <button id="regen">Regenerate insights</button>
      <button id="save" class="primary">Save Report</button>
      <button id="print">Print Report</button>
    </div>

    <div id="status" class="status"></div>

    <!-- Hidden file input for upload -->
    <input id="fileInput" type="file" accept=".csv,.tsv,.txt,.json,.xlsx,.xls" style="display:none" />

    <section class="section">
      <h2>Summary of Key Findings</h2>
      <div id="summary" class="summary">Loadingâ€¦</div>
      <div id="parent-quote" class="quote"></div>
    </section>

    <section class="section page-break">
      <h2>Traffic-Light Summary of Concerns</h2>
      <div><b>High Concerns:</b> <span id="tl-high">â€”</span></div>
      <div style="margin-top:6px;"><b>Some Concerns:</b> <span id="tl-some">â€”</span></div>
      <div style="margin-top:6px;"><b>No Concerns:</b> <span id="tl-no">â€”</span></div>
      <div class="chips" id="chips-hi" style="margin-top:8px;"></div>
      <div class="chips" id="chips-some" style="margin-top:6px;"></div>
      <div class="chips" id="chips-no" style="margin-top:6px;"></div>
    
      <!-- NEW: debug explanation of how domains were bucketed -->
      <div id="traffic-debug"
           style="font-size:13px; color:var(--muted); margin-top:10px;"></div>
    </section>    

    <section class="section page-break">
      <h2>Burden of Conversation (Parent-Reported Focus)</h2>
      <canvas id="burdenChart" width="800" aria-label="Burden chart"></canvas>
      <div style="font-size:12px;color:var(--muted); margin-top:8px;">
        Chart shows each domain's share (sums â‰ˆ 100%). Labels are printed on bars; use
        "Use Frequency" or "Use Quotes" to switch modes. In "Use Quotes" mode, only
        quotes where the response was <b>Yes</b> are included (quotes marked "No" are ignored).
      </div>      
    </section>

    <section class="section page-break">
      <h2>Recommendations and Next Steps (Based on Parent Concerns)</h2>
      <!-- Debug info about how recommendations were calculated -->
      <div id="recs-debug"
           style="font-size:13px; color:var(--muted); margin-bottom:8px;"></div>
      <ul id="recs" style="margin:0; padding-left:20px;"></ul>
    </section>

    <section class="section page-break">
      <h2>Domain-Specific Notes & Quotes</h2>
      <div class="domains" id="domains"></div>
    </section>

    <div class="foot">
      <div>
        This summary is based on a parent telephone interview and is for discussion purposes only.
        It does not replace a full clinical assessment.
      </div>
      <div id="stamp"></div>
    </div>
  </div>

  <script>
    const sessionId = "{{ session_id }}";
    const regenBtn = document.getElementById('regen');
    const saveBtn = document.getElementById('save');
    const printBtn = document.getElementById('print');
    const modeFreqBtn = document.getElementById('modeFreq');
    const modeQuotesBtn = document.getElementById('modeQuotes');
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('fileInput');

    const statusEl = document.getElementById('status');
    const stampEl = document.getElementById('stamp');

    const summaryEl = document.getElementById('summary');
    const quoteEl = document.getElementById('parent-quote');

    const tlHighEl = document.getElementById('tl-high');
    const tlSomeEl = document.getElementById('tl-some');
    const tlNoEl = document.getElementById('tl-no');

    const chipsHi = document.getElementById('chips-hi');
    const chipsSome = document.getElementById('chips-some');
    const chipsNo = document.getElementById('chips-no');

    const recsEl = document.getElementById('recs');
    const domainsEl = document.getElementById('domains');
    const recsDebugEl = document.getElementById('recs-debug'); // NEW
    const trafficDebugEl = document.getElementById('traffic-debug'); // NEW



    let chartInstance = null;
    let rows_cache = null;
    let currentMode = "frequency"; // or "quotes"

    const DOMAIN_ORDER = [
      "Anxiety / Emotion",
      "Attention / ADHD",
      "Autism",
      "Behaviour",
      "Care History",
      "Developmental History",
      "Eating",
      "Home Life / Routine",
      "Learning / Dyslexia",
      "Motor Skills",
      "Other",
      "Parent's Goal for this Assessment",
      "School Life",
      "Sleep",
      "Social / Communication",
      "Strengths / Interests"
    ];

    function showStatus(msg, type="ok") {
      statusEl.textContent = msg;
      statusEl.className = `status show ${type === "err" ? "err" : "ok"}`;
    }
    function clearStatus() {
      statusEl.className = "status";
      statusEl.textContent = "";
    }
    function setStamp() {
      const dt = new Date();
      stampEl.textContent = "Last generated: " +
        dt.toLocaleDateString(undefined, {year:"numeric", month:"short", day:"2-digit"}) + " " +
        dt.toLocaleTimeString(undefined, {hour:"2-digit", minute:"2-digit"});
    }

    function parseList(value) {
      if (!value) return [];
      if (Array.isArray(value)) return value.map(v => String(v));
      const raw = String(value)
        .split(/\r?\n|,/)
        .map(s => s.trim())
        .filter(Boolean);
      const seen = new Set(); const out = [];
      for (const s of raw) {
        const key = s.toLowerCase();
        if (!seen.has(key)) { seen.add(key); out.push(s); }
      }
      return out;
    }

    function chip(text, cls) {
      const d = document.createElement('div');
      d.className = `chip ${cls}`;
      d.textContent = text;
      return d;
    }

    function badge(level) {
      const span = document.createElement('span');
      span.className = "domain-badge " +
        (level === "high" ? "badge-hi" : level === "some" ? "badge-some" : "badge-no");
      span.textContent =
        level === "high" ? "High concern" :
        level === "some" ? "Some concern" :
        "No concern";
      return span;
    }

    function levelFromPercent(p) {
      if (p === null || p === undefined) return "some";
      const x = Number(p) || 0;
      if (x > 70) return "high";
      if (x >= 40) return "some";
      if (x < 30) return "no";
      return "some";
    }

        // Backend uses: >70 -> hi, >=30 -> some, <30 -> no
    function recConcernLevelFromPercent(p) {
      const x = Number(p) || 0;
      if (x > 70) return "hi";
      if (x >= 30) return "some";
      return "no";
    }


    function buildChartData(domain_scores_obj, mode) {
      const labels = [];
      const values = [];
      DOMAIN_ORDER.forEach(d => {
        let val = 0;
        const entry = domain_scores_obj && domain_scores_obj[d];
        if (!entry) {
          val = 0;
        } else {
          if (mode === "frequency") {
            val = Number(entry.freq_share || entry.freq_percent || 0);
          } else {
            val = Number(entry.quote_share || 0);
          }
        }
        labels.push(d);
        values.push(Math.max(0, Number(val)));
      });

      const sum = values.reduce((a,b) => a+b, 0);
      if (sum > 0 && !(Math.abs(sum - 100) <= 1)) {
        for (let i=0;i<values.length;i++) values[i] = (values[i] / sum) * 100;
      }
      const rounded = values.map(v => Math.round(v * 10) / 10);
      return { labels, values: rounded };
    }

    const BarLabelPlugin = {
      id: 'barLabelPlugin',
      afterDatasetsDraw(chart, args, pluginOptions) {
        const ctx = chart.ctx;
        chart.data.datasets.forEach((dataset, dsIndex) => {
          const meta = chart.getDatasetMeta(dsIndex);
          meta.data.forEach((bar, index) => {
            const val = dataset.data[index];
            if (val === null || val === undefined) return;
            const label = (Math.round(Number(val) * 10) / 10) + '%';
            ctx.save();
            ctx.font = '12px ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial';
            ctx.fillStyle = '#111827';
            ctx.textBaseline = 'middle';
            const box = bar.getProps(['x','y','width','height'], true);
            const textX = Math.max(box.x + 6, 6);
            const textY = box.y;
            ctx.fillText(label, textX, textY);
            ctx.restore();
          });
        });
      }
    };

    function createBurdenChart(labels, values, opts = {}) {
      const canvas = document.getElementById('burdenChart');
      const ctx = canvas.getContext('2d');

      if (chartInstance) {
        try { chartInstance.destroy(); } catch (e) { console.warn("destroy err", e); }
        chartInstance = null;
      }

      const responsive =
        (typeof opts.responsive === 'boolean') ? opts.responsive : true;
      const maintainAspectRatio =
        (typeof opts.maintainAspectRatio === 'boolean') ? opts.maintainAspectRatio : true;

      const maxVal = (values && values.length) ? Math.max(...values) : 0;
      const buffer = Math.max(5, Math.ceil(maxVal * 0.10));
      const suggestedMax = Math.min(100, Math.ceil(maxVal + buffer));

      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Share (%)',
            data: values,
            backgroundColor: labels.map((l, i) => {
              const palette = ['#e8505b','#f08a4b','#f5b86b','#b9d36b','#7fd0a8','#6fc2d6','#9ea0ff'];
              return palette[i % palette.length];
            }),
            borderColor: 'rgba(0,0,0,0.03)',
            borderWidth: 1,
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: responsive,
          maintainAspectRatio: maintainAspectRatio,
          scales: {
            x: {
              beginAtZero: true,
              suggestedMax: suggestedMax,
              ticks: {
                callback: (v) => `${v}%`
              }
            },
            y: {
              ticks: { autoSkip: false },
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(ctx) { return `${ctx.parsed.x}%`; }
              }
            }
          }
        },
        plugins: [BarLabelPlugin]
      });

      return chartInstance;
    }

    function renderBurdenChart(domain_scores_obj, mode) {
      const { labels, values } = buildChartData(domain_scores_obj, mode);
      createBurdenChart(labels, values, { responsive: true, maintainAspectRatio: true });
    }

    function beforePrintHandler() {
      // Expand all quote blocks (for PDF)
      document.querySelectorAll('.hidden-quotes').forEach(el => {
        el.style.display = '';        // make sure they are visible
      });
      document.querySelectorAll('.quotes-list').forEach(container => {
        if (container.dataset) {
          container.dataset.collapsed = "false";
        }
      });

      // Just ensure the existing chart knows its size â€“ don't recreate it
      if (chartInstance) {
        try {
          chartInstance.resize();
        } catch (e) {
          console.warn("Chart resize before print failed:", e);
        }
      }
    }
    function afterPrintHandler() {
      if (chartInstance) {
        try {
          chartInstance.resize();
        } catch (e) {
          console.warn("Chart resize after print failed:", e);
        }
      }
    }

    if (window.matchMedia) {
      window.addEventListener('beforeprint', beforePrintHandler);
      window.addEventListener('afterprint', afterPrintHandler);
    }

    function renderTrafficLights(rows, mode) {
      chipsHi.innerHTML = "";
      chipsSome.innerHTML = "";
      chipsNo.innerHTML = "";
      if (trafficDebugEl) trafficDebugEl.innerHTML = "";

      let hiList = [], someList = [], noList = [];
      if (mode === "frequency") {
        hiList = rows?.traffic_freq_high?.list || parseList(rows?.traffic_freq_high?.value);
        someList = rows?.traffic_freq_some?.list || parseList(rows?.traffic_freq_some?.value);
        noList = rows?.traffic_freq_no?.list || parseList(rows?.traffic_freq_no?.value);
      } else {
        hiList = rows?.traffic_quote_high?.list || parseList(rows?.traffic_quote_high?.value);
        someList = rows?.traffic_quote_some?.list || parseList(rows?.traffic_quote_some?.value);
        noList = rows?.traffic_quote_no?.list || parseList(rows?.traffic_quote_no?.value);
      }

      const deduped = new Set();
      const finalHi = [], finalSome = [], finalNo = [];
      for (const x of hiList || []) {
        const key = String(x).toLowerCase();
        if (!deduped.has(key)) { deduped.add(key); finalHi.push(String(x)); }
      }
      for (const x of someList || []) {
        const key = String(x).toLowerCase();
        if (!deduped.has(key)) { deduped.add(key); finalSome.push(String(x)); }
      }
      for (const x of noList || []) {
        const key = String(x).toLowerCase();
        if (!deduped.has(key)) { deduped.add(key); finalNo.push(String(x)); }
      }

      tlHighEl.textContent = finalHi.length ? finalHi.join(", ") : "â€”";
      tlSomeEl.textContent = finalSome.length ? finalSome.join(", ") : "â€”";
      tlNoEl.textContent = finalNo.length ? finalNo.join(", ") : "â€”";

      finalHi.forEach(x => chipsHi.appendChild(chip(x, "hi")));
      finalSome.forEach(x => chipsSome.appendChild(chip(x, "some")));
      finalNo.forEach(x => chipsNo.appendChild(chip(x, "no")));

      // ---- NEW: print the underlying percentages + levels ----
      const domainObjects = rows?.domain_objects || {};
      const debugLines = [];

      DOMAIN_ORDER.forEach(domainName => {
        const dobj = domainObjects[domainName] || {};

        let metricName, metricValue;
        if (mode === "quotes") {
          metricName = "quote_share";
          metricValue = Number(dobj.quote_share || 0);
        } else {
          metricName = "freq_percent";
          metricValue = Number(dobj.freq_percent || 0);
        }

        const levelCode = recConcernLevelFromPercent(metricValue); // hi/some/no
        const levelLabel =
          levelCode === "hi"   ? "High concern" :
          levelCode === "some" ? "Some concern" :
                                 "No concern";

        const bucket =
          levelCode === "hi"   ? "High Concerns" :
          levelCode === "some" ? "Some Concerns" :
                                 "No Concerns";

        const prettyValue = metricValue.toFixed(1);
        debugLines.push(
          `${domainName}: ${metricName} = ${prettyValue}% â†’ ${levelLabel} (${levelCode}) â†’ goes into "${bucket}".`
        );
      });

      if (trafficDebugEl && debugLines.length) {
        trafficDebugEl.innerHTML = debugLines
          .map(txt => `<div>${txt}</div>`)
          .join("");
      }
    }

    function renderRecommendations(rows, mode) {
      recsEl.innerHTML = "";
      if (recsDebugEl) recsDebugEl.innerHTML = "";

      // --- 1. Pick the correct source based on mode ---
      let src;
      if (mode === "quotes") {
        // IMPORTANT: in quotes mode we ONLY use recommendations_quotes.
        // We DO NOT fall back to frequency recommendations.
        src = rows?.recommendations_quotes || null;
      } else {
        // Frequency mode: use freq-based list, fall back to legacy if needed.
        src = rows?.recommendations_freq || rows?.recommendations || null;
      }

      const items = Array.isArray(src?.list) ? src.list : [];

      // --- 2. Handle empty lists correctly ---
      if (mode === "quotes" && (!src || !items.length)) {
        // No domains reached some/high concern based on quote_share
        recsEl.innerHTML = "<ol><li>â€”</li></ol>";
        if (recsDebugEl) {
          recsDebugEl.textContent =
            "No recommendations were generated in 'Use Quotes' mode because no domains reached 'some' or 'high' concern based on quote share.";
        }
        return;
      }

      if (!items.length) {
        // For frequency mode (or legacy), nothing crossed the threshold
        recsEl.innerHTML = "<ol><li>â€”</li></ol>";
        if (recsDebugEl) {
          recsDebugEl.textContent =
            "No recommendations were generated because no domains reached 'some' or 'high' concern.";
        }
        return;
      }

      // --- 3. Build debug explanation, matching backend logic ---
      const domainObjects = rows?.domain_objects || {};
      const debugLines = [];

      items.forEach(line => {
        const str = String(line || "");
        const domainName = str.split(":")[0].trim();   // "Anxiety / Emotion" from "Anxiety / Emotion: ..."
        const dobj = domainObjects[domainName] || {};

        let metricName, metricValue;
        if (mode === "quotes") {
          metricName  = "quote_share";
          metricValue = Number(dobj.quote_share || 0);
        } else {
          metricName  = "freq_percent";
          metricValue = Number(dobj.freq_percent || 0);
        }

        const levelCode = recConcernLevelFromPercent(metricValue); // hi/some/no
        const levelLabel =
          levelCode === "hi"   ? "High concern"  :
          levelCode === "some" ? "Some concern"  :
                                 "No concern";

        const prettyValue = metricValue.toFixed(1);
        debugLines.push(
          `${domainName}: ${metricName} = ${prettyValue}% â†’ ${levelLabel} (${levelCode}) used to select this recommendation.`
        );
      });

      if (recsDebugEl && debugLines.length) {
        recsDebugEl.innerHTML = debugLines
          .map(txt => `<div>${txt}</div>`)
          .join("");
      }

      // --- 4. Render the numbered recommendation list itself ---
      const ol = document.createElement("ol");
      items.forEach(line => {
        const li = document.createElement("li");
        li.textContent = line;
        ol.appendChild(li);
      });
      recsEl.appendChild(ol);
    }


    function makeShowMore(quotesContainer, allQuotes) {
      const MAX_VISIBLE = 6;
      if (!allQuotes || allQuotes.length <= MAX_VISIBLE) {
        quotesContainer.dataset.collapsed = "false";
        allQuotes.forEach(q => {
          const qdiv = document.createElement('div');
          qdiv.className = "quote-line";
          qdiv.textContent = 'â€œ' + String(q).replace(/^["â€œ]+|["â€]+$/g,'') + 'â€';
          quotesContainer.appendChild(qdiv);
        });
        return;
      }
      quotesContainer.dataset.collapsed = "true";
      const visible = allQuotes.slice(0, MAX_VISIBLE);
      visible.forEach(q => {
        const qdiv = document.createElement('div');
        qdiv.className = "quote-line";
        qdiv.textContent = 'â€œ' + String(q).replace(/^["â€œ]+|["â€]+$/g,'') + 'â€';
        quotesContainer.appendChild(qdiv);
      });
      const hiddenContainer = document.createElement('div');
      hiddenContainer.style.display = 'none';
      hiddenContainer.className = 'hidden-quotes';
      allQuotes.slice(MAX_VISIBLE).forEach(q => {
        const qdiv = document.createElement('div');
        qdiv.className = "quote-line";
        qdiv.textContent = 'â€œ' + String(q).replace(/^["â€œ]+|["â€]+$/g,'') + 'â€';
        hiddenContainer.appendChild(qdiv);
      });
      quotesContainer.appendChild(hiddenContainer);
      const btn = document.createElement('button');
      btn.className = 'show-more';
      btn.textContent = `Show ${allQuotes.length - MAX_VISIBLE} more`;
      btn.addEventListener('click', () => {
        const collapsed = quotesContainer.dataset.collapsed === "true";
        if (collapsed) {
          hiddenContainer.style.display = '';
          btn.textContent = 'Show less';
          quotesContainer.dataset.collapsed = "false";
        } else {
          hiddenContainer.style.display = 'none';
          btn.textContent = `Show ${allQuotes.length - MAX_VISIBLE} more`;
          quotesContainer.dataset.collapsed = "true";
        }
      });
      quotesContainer.appendChild(btn);
    }

    function renderDomains(rows, mode) {
      domainsEl.innerHTML = "";
      const domain_objects = rows.domain_objects || {};

      for (const title of DOMAIN_ORDER) {
        const key = 'domain_' + title.toLowerCase().replace(/[^a-z0-9]+/g, '_');
        const obj = domain_objects[title] || rows[key] || {};

        const card = document.createElement('div');
        card.className = "domain-card";

        // ---- header (title + badge) ----
        const h = document.createElement('div');
        h.className = "domain-title";
        const left = document.createElement('div');
        left.textContent = title;

        const level = (() => {
          if (mode === "frequency") {
            return levelFromPercent(obj.freq_percent || obj.freq_share || 0);
          }
          return levelFromPercent(obj.quote_share || 0);
        })();
        const right = badge(level);

        h.appendChild(left);
        h.appendChild(right);
        card.appendChild(h);

        // ---- main line / description ----
        const valLine = document.createElement('div');
        valLine.style.fontWeight = '600';
        valLine.style.marginBottom = '6px';
        const shownText = obj.value || "NA";
        valLine.textContent = shownText || "â€”";
        card.appendChild(valLine);

        // ---- quotes: YES vs NO, no inference ----
        const yesQuotes = Array.isArray(obj.yes_quotes)
          ? obj.yes_quotes
          : (Array.isArray(obj.unique_quotes) ? obj.unique_quotes : []);

        const noQuotes = Array.isArray(obj.no_quotes) ? obj.no_quotes : [];

        const quotesContainer = document.createElement('div');
        quotesContainer.className = 'quotes-list';

        if (yesQuotes.length) {
          const labelYes = document.createElement('div');
          labelYes.style.fontWeight = '600';
          labelYes.style.fontSize = '13px';
          labelYes.textContent = 'Yes (used in charts):';
          quotesContainer.appendChild(labelYes);

          const yesListContainer = document.createElement('div');
          yesListContainer.className = 'quotes-list';
          makeShowMore(yesListContainer, yesQuotes);
          quotesContainer.appendChild(yesListContainer);
        }

        if (noQuotes.length) {
          const labelNo = document.createElement('div');
          labelNo.style.fontWeight = '600';
          labelNo.style.fontSize = '13px';
          labelNo.style.marginTop = '4px';
          labelNo.textContent = 'No (ignored in charts):';
          quotesContainer.appendChild(labelNo);

          const noListContainer = document.createElement('div');
          noListContainer.className = 'quotes-list';
          makeShowMore(noListContainer, noQuotes);
          quotesContainer.appendChild(noListContainer);
        }

        // If we have no quotes at all, show a simple dash
        if (!yesQuotes.length && !noQuotes.length) {
          const qdiv = document.createElement('div');
          qdiv.className = "quote-line";
          qdiv.style.opacity = 0.8;
          qdiv.textContent = "â€”";
          quotesContainer.appendChild(qdiv);
        }

        card.appendChild(quotesContainer);

        // ---- meta footer: counts ----
        const meta = document.createElement('div');
        meta.style.marginTop = '8px';
        meta.style.color = 'var(--muted)';
        meta.style.fontSize = '13px';

        const yesCount =
          yesQuotes.length ||
          Number(obj.quote_yes_count || obj.quote_count || 0) || 0;
        const noCount =
          noQuotes.length ||
          Number(obj.quote_no_count || 0) || 0;

        if (noCount > 0) {
          meta.textContent =
            `Quotes marked "Yes" (used in charts): ${yesCount} | ` +
            `marked "No" (ignored in charts): ${noCount}`;
        } else {
          meta.textContent =
            `Quotes marked "Yes" (used in charts): ${yesCount}`;
        }

        card.appendChild(meta);

        domainsEl.appendChild(card);
      }
    }

    async function regenerate() {
      clearStatus();
      showStatus("Generating insightsâ€¦", "ok");
      summaryEl.textContent = "Loadingâ€¦";
      quoteEl.textContent = "";
      recsEl.innerHTML = "";
      if (recsDebugEl) recsDebugEl.innerHTML = "";
      if (trafficDebugEl) trafficDebugEl.innerHTML = "";
      domainsEl.innerHTML = "";
      chipsHi.innerHTML = chipsSome.innerHTML = chipsNo.innerHTML = "";
      try {
        const res = await fetch(`/api/analytics/${encodeURIComponent(sessionId)}`);
        if (!res.ok) {
          const errBody = await res.text();
          showStatus("Analytics API error: " + res.status + " â€” see server logs", "err");
          summaryEl.textContent = "Error calling analytics API.";
          console.error("Analytics API failed:", res.status, errBody);
          return;
        }
        const data = await res.json();
        if (!data || !data.ok) {
          showStatus("Analytics responded with error: " + (data && data.error ? data.error : "unknown"), "err");
          summaryEl.textContent = "Error from analytics API.";
          return;
        }

        rows_cache = data.rows || {};
        const h = data.header || {};
        document.getElementById("child-name").textContent = h.child_name || "â€”";
        document.getElementById("child-age").textContent = h.child_age || "â€”";
        document.getElementById("doi").textContent = h.date_of_interview || "â€”";
        document.getElementById("parent").textContent = h.parent_respondent || "â€”";
        document.getElementById("interviewer").textContent = h.interviewer || "â€”";
        document.getElementById("ref-source").textContent = h.referral_source || "â€”";
        if (h.report_title) document.getElementById("report-title").textContent = h.report_title;

        summaryEl.textContent =
          rows_cache?.summary_overview?.value ||
          rows_cache?.summary_overview ||
          "â€”";
          let pq = "";
        if (rows_cache && rows_cache.parent_quote) {
          pq = rows_cache.parent_quote.quote || rows_cache.parent_quote.value || "";
        }
        quoteEl.textContent = pq ? ('Parent Quote: â€œ' + pq + 'â€') : "";

        renderRecommendations(rows_cache, currentMode);
        renderTrafficLights(rows_cache, currentMode);
        renderDomains(rows_cache, currentMode);

        const domain_scores = rows_cache.domain_scores || {};
        renderBurdenChart(domain_scores, currentMode);

        setStamp();
        showStatus("Insights generated successfully.", "ok");
      } catch (e) {
        console.error("Regenerate failed:", e);
        showStatus("Failed to generate insights. See console/server logs.", "err");
        summaryEl.textContent = "Failed to generate insights.";
      }
    }

    async function uploadAndGenerate(file) {
      if (!file) return;
      clearStatus();
      showStatus("Uploading file and generating insightsâ€¦", "ok");
      summaryEl.textContent = "Loadingâ€¦";
      quoteEl.textContent = "";
      recsEl.innerHTML = "";
      if (recsDebugEl) recsDebugEl.innerHTML = "";
      if (trafficDebugEl) trafficDebugEl.innerHTML = "";
      domainsEl.innerHTML = "";
      chipsHi.innerHTML = chipsSome.innerHTML = chipsNo.innerHTML = "";

      try {
        const form = new FormData();
        form.append('file', file, file.name);

        const res = await fetch('/api/analytics/upload', {
          method: 'POST',
          body: form
        });

        if (!res.ok) {
          const text = await res.text();
          console.error("Upload failed:", res.status, text);
          showStatus("Upload failed: " + res.status + " â€” see server logs", "err");
          summaryEl.textContent = "Upload failed.";
          return;
        }

        const data = await res.json();
        if (!data || !data.ok) {
          showStatus("Upload analytics error: " + (data && data.error ? data.error : "unknown"), "err");
          summaryEl.textContent = "Error processing uploaded file.";
          return;
        }

        rows_cache = data.rows || {};
        const h = data.header || {};
        document.getElementById("child-name").textContent = h.child_name || "â€”";
        document.getElementById("child-age").textContent = h.child_age || "â€”";
        document.getElementById("doi").textContent = h.date_of_interview || "â€”";
        document.getElementById("parent").textContent = h.parent_respondent || "â€”";
        document.getElementById("interviewer").textContent = h.interviewer || "â€”";
        document.getElementById("ref-source").textContent = h.referral_source || "â€”";
        if (h.report_title) document.getElementById("report-title").textContent = h.report_title;

        summaryEl.textContent =
          rows_cache?.summary_overview?.value ||
          rows_cache?.summary_overview ||
          "â€”";
          let pq = "";
        if (rows_cache && rows_cache.parent_quote) {
          pq = rows_cache.parent_quote.quote || rows_cache.parent_quote.value || "";
        }
        quoteEl.textContent = pq ? ('Parent Quote: â€œ' + pq + 'â€') : "";

        renderRecommendations(rows_cache, currentMode);
        renderTrafficLights(rows_cache, currentMode);
        renderDomains(rows_cache, currentMode);

        const domain_scores = rows_cache.domain_scores || {};
        renderBurdenChart(domain_scores, currentMode);

        setStamp();
        showStatus("Insights generated from uploaded file.", "ok");
      } catch (e) {
        console.error("UploadAndGenerate failed:", e);
        showStatus("Failed to upload or generate insights. See console/server logs.", "err");
        summaryEl.textContent = "Failed to upload or generate insights.";
      }
    }

    modeFreqBtn.addEventListener('click', () => {
      currentMode = "frequency";
      modeFreqBtn.classList.add('active'); modeQuotesBtn.classList.remove('active');
      if (rows_cache) {
        renderTrafficLights(rows_cache, currentMode);
        renderDomains(rows_cache, currentMode);
        renderRecommendations(rows_cache, currentMode);
        const domain_scores = rows_cache.domain_scores || {};
        renderBurdenChart(domain_scores, currentMode);
      }
    });

    modeQuotesBtn.addEventListener('click', () => {
      currentMode = "quotes";
      modeQuotesBtn.classList.add('active'); modeFreqBtn.classList.remove('active');
      if (rows_cache) {
        renderTrafficLights(rows_cache, currentMode);
        renderDomains(rows_cache, currentMode);
        renderRecommendations(rows_cache, currentMode);
        const domain_scores = rows_cache.domain_scores || {};
        renderBurdenChart(domain_scores, currentMode);
      }
    });

    regenBtn.addEventListener('click', regenerate);
    printBtn.addEventListener('click', () => {
      beforePrintHandler();
      setTimeout(() => window.print(), 300);
    });
    saveBtn.addEventListener('click', () => {
      beforePrintHandler();
      setTimeout(() => window.print(), 300);
    });

    uploadBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (ev) => {
      const f = ev.target.files && ev.target.files[0];
      if (!f) return;
      uploadAndGenerate(f);
      fileInput.value = "";
    });

    // Auto-load
    regenerate();
  </script>
</body>
</html>
